<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Alex Edwards">
  <meta name="copyright" content="Copyright Alex Edwards 2017">
  <title>Serving Static Files - Let's Go (Sample)</title>
  <link rel="stylesheet" type="text/css" href="assets/css/global.css">
  <link rel="stylesheet" type="text/css" href="assets/css/html.css">
  <script>
            (function(h,o,t,j,a,r){
                h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
                h._hjSettings={hjid:659192,hjsv:6};
                a=o.getElementsByTagName('head')[0];
                r=o.createElement('script');r.async=1;
                r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
                a.appendChild(r);
            })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
  </script>
</head>
<body>
  <div class="cta">
    <div class="wrapper">
      You're reading a sample of this book. <a href="https://gumroad.com/l/letsgo">Grab the full version here.</a>
    </div>
  </div>
  <header>
    <nav class="wrapper clearfix">
      <div class="breadcrumbs">
        <a href="00.00-lets-go.html">Let's Go</a> <span class="crumbs"><span class="separator">›</span> <a href="02.00-foundations.html">Foundations</a> <span class="separator">›</span> Serving Static Files</span>
      </div>
      <div class="menu">
        <span><a href="02.07-basic-html-templates.html" title="2.7. Basic HTML Templates">Previous</a> <span class="separator">·</span></span> <a href="00.01-contents.html" title="Contents">Contents</a> <span><span class="separator">·</span> <a href="02.09-the-http-handler-interface.html" title="2.9. The http.Handler Interface">Next</a></span>
      </div>
    </nav>
  </header>
  <section class="wrapper clearfix">
    <article>
      <h2 id="02.08-serving-static-files">2.8. Serving Static Files</h2>
      <p>In this chapter we'll improve the look and feel of our homepage by adding to some static CSS and image files to our application.</p>
      <p>If you're following along, you can grab the relevant files and extract them into the <code>ui/static</code> folder we made earlier with the following commands:</p>
      <div class="codeblock sh">
        <pre><span class='prompt'>$</span> cd $HOME/go/src/snippetbox.org
<span class='prompt'>$</span> curl http://www.alexedwards.net/static/sb.v100.tar.gz | tar -xvz -C ./ui/static/
</pre>
      </div>
      <p>The contents of your <code>ui/static</code> folder should now look like this:</p>
      <p><img src="assets/img/02.08-01.png" alt="02.08-01.png"></p>
      <h3>The http.FileServer Handler</h3>
      <p>The key to serving these static files from our web application is the <a href="https://golang.org/pkg/net/http/#FileServer"><code>http.FileServer()</code></a> function. This lets us create a <a href="https://golang.org/pkg/net/http/#FileServer"><code>http.FileServer</code></a> handler which serves files from a specific directory, like so:</p>
      <div class="codeblock go">
        <pre><span class="nx">fileServer</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileServer</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Dir</span><span class="p">(</span><span class="s">"./ui/static"</span><span class="p">))</span>
</pre>
      </div>
      <p>Let’s add a new route so that all requests which begin with <code>"/static/"</code> are handled by the file server (note how <code>"/static/"</code> is a subtree path pattern):</p>
      <table>
        <thead>
          <tr>
            <th style="text-align: left">URL Path</th>
            <th style="text-align: left">Handler</th>
            <th style="text-align: left">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="text-align: left">/</td>
            <td style="text-align: left">Home</td>
            <td style="text-align: left">Display a "Hello from Snippetbox" message</td>
          </tr>
          <tr>
            <td style="text-align: left">/snippet<span>?id=1</span></td>
            <td style="text-align: left">ShowSnippet</td>
            <td style="text-align: left">Display a specific snippet</td>
          </tr>
          <tr>
            <td style="text-align: left">/snippet/new</td>
            <td style="text-align: left">NewSnippet</td>
            <td style="text-align: left">Display the new snippet form</td>
          </tr>
          <tr>
            <td style="text-align: left">/static/<span>...</span></td>
            <td style="text-align: left">http.FileServer</td>
            <td style="text-align: left">Serve a specific static file</td>
          </tr>
        </tbody>
      </table>
      <p>When the <code>http.FileServer</code> handler receives a request, it will remove the leading slash from the URL path and then search the <code>./ui/static</code> directory for the corresponding file.</p>
      <p>So for this to work correctly we have to strip the leading <code>"/static"</code> from the URL path <em>before</em> passing it to <code>http.FileServer</code>, otherwise it will be looking for a file which doesn't exist and the user will receive a <code>404 Not Found</code> response. Fortunately Go includes a <a href="https://golang.org/pkg/net/http/#StripPrefix"><code>http.StripPrefix()</code></a> helper specifically for the task.</p>
      <p>Open up your <code>main.go</code> file and add the following code, so that the file ends up looking like this:</p>
      <div class="group">
        <div class="codeblock-title">
          cmd/web/main.go
        </div>
        <div class="codeblock go">
          <pre><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">"log"</span>
    <span class="s">"net/http"</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="nx">Home</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">"/snippet"</span><span class="p">,</span> <span class="nx">ShowSnippet</span><span class="p">)</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">"/snippet/new"</span><span class="p">,</span> <span class="nx">NewSnippet</span><span class="p">)</span>

    <span class="c1">// Create a file server which serves files out of the "./ui/static" directory.</span>
    <span class="c1">// As before, the path given to the http.Dir function is relative to our project</span>
    <span class="c1">// repository root.</span>
    <span class="nx">fileServer</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileServer</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Dir</span><span class="p">(</span><span class="s">"./ui/static"</span><span class="p">))</span>

    <span class="c1">// Use the mux.Handle() function to register the file server as the</span>
    <span class="c1">// handler for all URL paths that start with "/static/". For matching</span>
    <span class="c1">// paths, we strip the "/static" prefix before the request reaches the file</span>
    <span class="c1">// server.</span>
    <span class="nx">mux</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">"/static/"</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StripPrefix</span><span class="p">(</span><span class="s">"/static"</span><span class="p">,</span> <span class="nx">fileServer</span><span class="p">))</span>

    <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">"Starting server on :4000"</span><span class="p">)</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">":4000"</span><span class="p">,</span> <span class="nx">mux</span><span class="p">)</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre>
        </div>
      </div>
      <p>Once that's complete, save the file and restart the application.</p>
      <p>Try taking a look at <a href="http://localhost:4000/static/"><code>http://localhost:4000/static/</code></a> in your browser and you should see a navigable directory listing of the <code>./ui/static</code> folder, a bit like this:</p>
      <p><img src="assets/img/02.08-02.png" alt="02.08-02.png"></p>
      <p>If you browse through, you should be able to view the individual files. For example, if you navigate to <a href="http://localhost:4000/static/css/main.css"><code>http://localhost:4000/static/css/main.css</code></a> you should see the CSS file appear in your browser, like so:</p>
      <p><img src="assets/img/02.08-03.png" alt="02.08-03.png"></p>
      <h3>Using the Static Files</h3>
      <p>With that done, we can now update our <code>ui/html/base.html</code> file to make use of these static files:</p>
      <div class="group">
        <div class="codeblock-title">
          ui/html/base.html
        </div>
        <div class="codeblock html">
          <pre>{{define "base"}}
<span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>{{template "page-title" .}} - Snippetbox<span class="nt">&lt;/title&gt;</span>
        <span class="c">&lt;!-- Link to the CSS stylesheet and favicon --&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/static/css/main.css"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"shortcut icon"</span> <span class="na">href=</span><span class="s">"/static/img/favicon.ico"</span> <span class="na">type=</span><span class="s">"image/x-icon"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;header&gt;</span>
            <span class="nt">&lt;h1&gt;&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Snippetbox<span class="nt">&lt;/a&gt;&lt;/h1&gt;</span>
        <span class="nt">&lt;/header&gt;</span>
        <span class="nt">&lt;nav&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/"</span><span class="nt">&gt;</span>Home<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/snippet/new"</span><span class="nt">&gt;</span>New snippet<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/nav&gt;</span>
        <span class="nt">&lt;section&gt;</span>
            {{template "page-body" .}}
        <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
{{end}}
</pre>
        </div>
      </div>
      <p>Make sure you save all your changes then visit <a href="http://localhost:4000/"><code>http://localhost:4000/</code></a>. If everything has worked correctly you should see a homepage which looks like this:</p>
      <p><img src="assets/img/02.08-04.png" alt="02.08-04.png"></p>
      <hr>
      <h3>Notes</h3>
      <h4>Features and Functions</h4>
      <p>Go's <code>http.FileServer</code> has a few really nice features that are worthy of a mention:</p>
      <ul>
        <li>
          <p>It sanitizes all request paths by running them through the <a href="https://golang.org/pkg/path/#Clean"><code>path.Clean()</code></a> function before searching for a file. This removes any <code>.</code> and <code>..</code> elements from the URL path, which helps to stop directory traversal attacks.</p>
        </li>
        <li>
          <p><a href="https://benramsey.com/blog/2008/05/206-partial-content-and-range-requests">Range requests</a> are fully supported. This is great if your application is serving large files and you want to support resumable downloads. You can see this functionality in action if you use curl to request bytes 100-199 of our <code>logo.png</code> file, like so:</p>
          <div class="codeblock sh">
            <pre><span class='prompt'>$</span> curl -i -H "Range: bytes=100-199" http://localhost:4000/static/img/logo.png
<samp>HTTP/1.1 206 Partial Content
Accept-Ranges: bytes
Content-Length: 100
Content-Range: bytes 100-199/1075
Content-Type: image/png
Last-Modified: Thu, 04 May 2017 13:07:52 GMT
Date: Sat, 19 Aug 2017 09:12:49 GMT

h�j��ZbK�&amp;�"b��dS�"V��M�PQ�S�T��x�PMC1���&amp;�.(غ�   ����&amp;�"^"� ZI</samp>
</pre>
          </div>
        </li>
        <li>
          <p>The <code>Last-Modified</code> and <code>If-Modified-Since</code> headers are transparently supported. If a file hasn’t changed since the user last requested it, then Go will send a <code>304 Not Modified</code> status code instead of the file itself. This helps reduce latency and processing overhead for both the client and server</p>
        </li>
        <li>
          <p>The <code>Content-Type</code> is automatically set from the file extension using the <a href="https://golang.org/pkg/mime/#TypeByExtension"><code>mime.TypeByExtension()</code></a> function. You can add your own custom extensions and content types using the <a href="https://golang.org/pkg/mime/#AddExtensionType"><code>mime.AddExtensionType()</code></a> function if necessary.</p>
        </li>
      </ul>
      <h4>Serving Single Files</h4>
      <p>Sometimes you might want to serve a single file from within a handler. For this there's the <a href="https://golang.org/pkg/net/http/#ServeFile"><code>http.ServeFile()</code></a> function:</p>
      <div class="codeblock go">
        <pre><span class="kd">func</span> <span class="nx">FooHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">file</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="s">"./ui/static"</span><span class="p">,</span> <span class="s">"foo.zip"</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">ServeFile</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">file</span><span class="p">)</span>
<span class="p">}</span>
</pre>
      </div>
      <p><strong>But be aware</strong>: <code>http.ServeFile()</code> does not automatically sanitize the file path. If you're constructing a file path from untrusted user input, you <strong>must</strong> sanitize the input with <a href="https://golang.org/pkg/path/filepath/#Clean"><code>filepath.Clean()</code></a> before using it to avoid directory traversal attacks.</p>
    </article>
  </section>
  <footer>
    <span><a href="02.07-basic-html-templates.html" title="2.7. Basic HTML Templates">Previous</a></span> · <a href="00.01-contents.html" title="Contents">Contents</a> · <span><a href="02.09-the-http-handler-interface.html" title="2.9. The http.Handler Interface">Next</a></span>
  </footer>
  <script type="text/javascript">
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-23830196-1']);
                _gaq.push(['_trackPageview']);
                (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();
  </script>
</body>
</html>
